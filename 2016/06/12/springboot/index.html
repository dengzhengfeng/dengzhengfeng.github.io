<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />








  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>


    <meta name="description" content="dengzhengfeng1991@126.com" />



  <meta name="keywords" content="springboot,jpa," />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1" />


<meta name="description" content="最近一个小工具使用了beego，发现原来java项目手工配置真的是太累了。在接触了Grails后，觉得Grails虽然好用，但是并不完全顺手。看了spring4和springboot后，才发现使用springboot可以非常整洁了。同时结合注解可以完全脱离xml的配置（spring的配置和web.xml的配置）。现在从头开始搭建无xml配置web应用。代码地址 准备环境  项目管理使用gradle">
<meta name="keywords" content="springboot,jpa">
<meta property="og:type" content="article">
<meta property="og:title" content="使用springboot+jpa快速搭建无xml配置web应用">
<meta property="og:url" content="http://yoursite.com/2016/06/12/springboot/index.html">
<meta property="og:site_name" content="个人博客">
<meta property="og:description" content="最近一个小工具使用了beego，发现原来java项目手工配置真的是太累了。在接触了Grails后，觉得Grails虽然好用，但是并不完全顺手。看了spring4和springboot后，才发现使用springboot可以非常整洁了。同时结合注解可以完全脱离xml的配置（spring的配置和web.xml的配置）。现在从头开始搭建无xml配置web应用。代码地址 准备环境  项目管理使用gradle">
<meta property="og:image" content="http://yoursite.com/img/springboot/onetomany.png">
<meta property="og:image" content="http://yoursite.com/img/springboot/transaction.png">
<meta property="og:updated_time" content="2017-05-16T01:34:50.090Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用springboot+jpa快速搭建无xml配置web应用">
<meta name="twitter:description" content="最近一个小工具使用了beego，发现原来java项目手工配置真的是太累了。在接触了Grails后，觉得Grails虽然好用，但是并不完全顺手。看了spring4和springboot后，才发现使用springboot可以非常整洁了。同时结合注解可以完全脱离xml的配置（spring的配置和web.xml的配置）。现在从头开始搭建无xml配置web应用。代码地址 准备环境  项目管理使用gradle">
<meta name="twitter:image" content="http://yoursite.com/img/springboot/onetomany.png">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post'
  };
</script>

  <title> 使用springboot+jpa快速搭建无xml配置web应用 | 个人博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>
      <span class="site-title">个人博客</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            <i class="menu-item-icon icon-next-categories"></i> <br />
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            <i class="menu-item-icon icon-next-about"></i> <br />
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-next-archives"></i> <br />
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-next-tags"></i> <br />
            标签
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              使用springboot+jpa快速搭建无xml配置web应用
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2016-06-12T15:46:16+08:00" content="2016-06-12">
            2016-06-12
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/springboot/" itemprop="url" rel="index">
                  <span itemprop="name">springboot</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2016/06/12/springboot/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/12/springboot/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><p>最近一个小工具使用了beego，发现原来java项目手工配置真的是太累了。在接触了Grails后，觉得Grails虽然好用，但是并不完全顺手。看了spring4和springboot后，才发现使用springboot可以非常整洁了。同时结合注解可以完全脱离xml的配置（spring的配置和web.xml的配置）。现在从头开始搭建无xml配置web应用。<a href="https://github.com/dengzhengfeng/springboot" target="_blank" rel="external">代码地址</a></p>
<p></p><h2 id="context">准备环境</h2><p></p>
<blockquote>
<p>项目管理使用gradle 开发工具使用sts 数据库使用postgresql</p>
<p></p><h2 id="gradle">初始化项目</h2><br>使用gradle创建一个java项目<br><code>gradle init --type java-library</code><p></p>
<p></p><h2 id="ide">导入IDE</h2><br>导入IDE，不同的IDE可能会需要不同的插件，比如sts需要gradle的插件<p></p>
<p></p><h2 id="dependency">配置依赖</h2><br>配置build.gradle<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">buildscript &#123;</div><div class="line">    repositories &#123;</div><div class="line">        jcenter()</div><div class="line">        maven &#123; url &quot;http://repo.spring.io/snapshot&quot; &#125;</div><div class="line">        maven &#123; url &quot;http://repo.spring.io/milestone&quot; &#125;</div><div class="line">    &#125;</div><div class="line">    dependencies &#123;</div><div class="line">        classpath(&quot;org.springframework.boot:spring-boot-gradle-plugin:1.3.5.RELEASE&quot;)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">apply plugin: &apos;java&apos;</div><div class="line">apply plugin: &apos;spring-boot&apos;</div><div class="line"></div><div class="line">jar &#123;</div><div class="line">    baseName = &apos;boot&apos;</div><div class="line">    version =  &apos;0.0.1-SNAPSHOT&apos;</div><div class="line">&#125;</div><div class="line"></div><div class="line">repositories &#123;</div><div class="line">    jcenter()</div><div class="line">    maven &#123; url &quot;http://repo.spring.io/snapshot&quot; &#125;</div><div class="line">    maven &#123; url &quot;http://repo.spring.io/milestone&quot; &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">dependencies &#123;</div><div class="line">	compile(&quot;org.springframework.boot:spring-boot-starter-web&quot;)</div><div class="line">    testCompile(&quot;org.springframework.boot:spring-boot-starter-test&quot;)</div><div class="line">&#125;</div><div class="line">//入口类，需要编写对应类</div><div class="line">springBoot &#123;</div><div class="line">    mainClass = &quot;org.dzf.Application&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p>
</blockquote>
<p></p><h2 id="hello">Hello World！</h2><p></p>
<blockquote>
<p>官方包路径为domain service web</p>
</blockquote>
<p>我们按照官方建议建立包路径<br>-org.dzf<br>————————domain<br>————————service<br>————————web</p>
<blockquote>
<p>编写Controller类</p>
</blockquote>
<p>在web包下新建类<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@Controller</div><div class="line">@EnableAutoConfiguration</div><div class="line">public class HomeController &#123;</div><div class="line">	</div><div class="line">	@RequestMapping(&quot;/&quot;)</div><div class="line">	@ResponseBody</div><div class="line">	String home()&#123;</div><div class="line">		return &quot;Hello World!&quot;;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>@Controller 注解标识这个类是一个Controller类<br>@EnableAutoConfiguration 是让spring自动处理与拼装bean<br>@RequestMapping(“/“) 注解是springMVC的标识，处理映射路径<br>@ResponseBody 标识方法直接返回响应体如json数据，而不是一个view</p>
<blockquote>
<p>编写入口类</p>
</blockquote>
<p>在build.gradle中配置的入口类，也是启动项目的入口<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@SpringBootApplication</div><div class="line">public class Application &#123;</div><div class="line">	public static void main(String[] args) &#123;</div><div class="line">		SpringApplication.run(Application.class, args);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>@SpringBootApplication 标识这个一个程序入口（配置类）相当于@Configuration,@EnableAutoConfiguration和 @ComponentScan</p>
<p>因为spring boot内置了容器，我们直接运行Application，就可以启动默认的8080端口访问到Hello World程序了</p>
<p></p><h2 id="config">配置文件与资源文件</h2><p></p>
<blockquote>
<p>spring boot配置文件与资源文件都默认从src/main/resoureces获取</p>
</blockquote>
<p>静态文件路径src/main/resoureces/static<br>模板文件路径src/main/resoureces/templates</p>
<blockquote>
<p>配置文件可以使用application.properties或application.yml</p>
</blockquote>
<p>我选择的是application.yml的配置文件，同理application.properties也是类似的<br>新建编辑src/main/resoureces/application.yml文件<br>如我不想使用默认的8080端口，就在配置文件中新增配置<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">server: </div><div class="line">  port: 9090</div></pre></td></tr></table></figure></p>
<p>重启应用后，端口就可以发现启动端口是9090了</p>
<blockquote>
<p>官方并不建议使用jsp，这里我使用velocity<br>首先配置依赖<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">compile(&quot;org.springframework.boot:spring-boot-starter-velocity&quot;)</div></pre></td></tr></table></figure></p>
</blockquote>
<p>在templates目录下新建文件home.vm<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Hello Velocity!</div></pre></td></tr></table></figure></p>
<p>修改HomeController，删除@ResponseBody注解<br>重编译项目后，启动后就可以看到首页使用了Velocity对应的模版了</p>
<p></p><h2 id="jpa">使用jpa完成数据持久化</h2><p></p>
<blockquote>
<p>配置build.gradle 新增jpa的依赖（使用postgresql并建立对应的用户与库）</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">compile(&quot;org.springframework.boot:spring-boot-starter-data-jpa&quot;)</div><div class="line">compile(&quot;postgresql:postgresql:9.1-901-1.jdbc4&quot;)</div></pre></td></tr></table></figure>
<p>在配置文件配置（修改对应的配置）<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">spring:</div><div class="line">  datasource:</div><div class="line">    url: jdbc:postgresql://localhost:5432/dzf</div><div class="line">    username: dzf</div><div class="line">    password: 123456</div><div class="line">    # Keep the connection alive if idle for a long time (needed in production)</div><div class="line">    test-while-idle: true</div><div class="line">    validation-query: SELECT 1</div><div class="line">  jpa:</div><div class="line">    # Show or not log for each sql query</div><div class="line">    show-sql: true</div><div class="line">    hibernate:</div><div class="line">      # Hibernate ddl auto (create, create-drop, update)</div><div class="line">      ddl-auto: create</div><div class="line">      # Naming strategy</div><div class="line">      naming-strategy: org.hibernate.cfg.ImprovedNamingStrategy</div><div class="line">    # Use spring.jpa.properties.* for Hibernate native properties (the prefix is</div><div class="line">    # stripped before adding them to the entity manager)</div><div class="line">    # The SQL dialect makes Hibernate generate better SQL for the chosen database</div><div class="line">    properties:</div><div class="line">      hibernate:</div><div class="line">        dialect: org.hibernate.dialect.PostgreSQLDialect</div></pre></td></tr></table></figure></p>
<p>我们只使用了一个数据源，所以只需要覆盖默认的配置就可以了<br>我们假设一个实体 书（Book）对应表为bookdoc 创建domain类（在domain包下）<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@Entity</div><div class="line">@Table(name = &quot;bookdoc&quot;)</div><div class="line">public class Book &#123;</div><div class="line">	@Id</div><div class="line">	@GeneratedValue(generator = &quot;uuid2&quot;)</div><div class="line">    @GenericGenerator(name = &quot;uuid2&quot;, strategy = &quot;uuid2&quot;)</div><div class="line">	@Type(type=&quot;pg-uuid&quot;)</div><div class="line">	private UUID id;</div><div class="line">	@Column(length=64)</div><div class="line">	private String name;//书名</div><div class="line">	@Column(length=128)</div><div class="line">	private String publisher;//出版社</div><div class="line">	@Temporal(TemporalType.DATE)</div><div class="line">	private Date publisher_year;//出版时间</div><div class="line">	@Temporal(TemporalType.DATE)</div><div class="line">	private Date createtime;//创建时间</div><div class="line">	</div><div class="line">	@PrePersist</div><div class="line">	protected void onCreate() &#123;</div><div class="line">		createtime = new Date();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	//这里省略了get set方法</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>@Entity 标识这是一个实体类<br>@Table(name = “bookdoc”) 标识对应的表<br>@Id 标识主键字段<br>@Type(type=”pg-uuid”) 标识字段类型，这里我使用的是postgresql的uuid类型<br>@Column 标识字段<br>@GeneratedValue(generator = “uuid2”) @GenericGenerator(name = “uuid2”, strategy = “uuid2”) 标识自动创建uuid<br>@PrePersist 标识在创建时自动创建动作，这里会在插入行时自动插入创建时间</p>
<p>创建Repository接口<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@Repository(value=&quot;bookRepository&quot;)</div><div class="line">public interface BookRepository extends JpaRepository&lt;Book,UUID&gt;&#123;</div><div class="line">    @Query(&quot;select a from Book a where name like %:name%&quot;)</div><div class="line">	public List&lt;Book&gt; queryBook(@Param(&quot;name&quot;)String name,Pageable pageable);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>BookRepository可以空申名，因为它继承了JpaRepository，在这之后，我们可以通过spring注入的BookRepository对bookdoc表做简单的操作（如save、findAll），当然这应该是在service里做的，接下来我们完善service，创建BookService接口<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">public interface BookService &#123;</div><div class="line">	public void saveBook(Book book);</div><div class="line">	public List&lt;Book&gt; findBook(String bookName);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接口申明了两个方法，保存书和通过书名查找书，接下来我们编写实现类<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@Service(value = &quot;BookService&quot;)</div><div class="line">public class BookServiceImpl implements BookService&#123;</div><div class="line">	@Resource(name = &quot;bookRepository&quot;)</div><div class="line">	private BookRepository bookRepository;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public void saveBook(Book book) &#123;</div><div class="line">		bookRepository.save(book);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public Book findBook(String bookName) &#123;</div><div class="line">		Pageable pageable = new PageRequest(0,5);</div><div class="line">		return bookRepository.queryBook(bookName,pageable);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>@Service 标识实现类，spring自动注入BookService时会注入这个实现类<br>好了，我们在HomeController中调用对应的Service<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@Autowired</div><div class="line">	private BookService bookService;</div><div class="line"></div><div class="line">	@RequestMapping(&quot;/&quot;)</div><div class="line">	String home() &#123;</div><div class="line">		try &#123;</div><div class="line">			Book book = new Book();</div><div class="line">			book.setName(&quot;测试书&quot;);</div><div class="line">			book.setPublisher(&quot;测试出版社&quot;);</div><div class="line">			book.setPublisher_year(new SimpleDateFormat(&quot;yyyy-MM-dd&quot;).parse(&quot;2012-12-12&quot;));</div><div class="line">			bookService.saveBook(book);</div><div class="line">			</div><div class="line">			System.err.println(bookService.findBook(&quot;测试书&quot;));</div><div class="line">		&#125; catch (ParseException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">			return &quot;redirect:error&quot;;</div><div class="line">		&#125;</div><div class="line">		return &quot;home&quot;;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>启动项目后，访问主页就可以测试了（查询使用了JPQL，分页只要传入Pageable参数）</p>
<p></p><h2 id="mapping">关系映射</h2><p></p>
<blockquote>
<p>在这里，比如每一本具体的书只能被一个学生拥有，每个学生可以拥有多本书</p>
</blockquote>
<p>在Book类中新增一个属性<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@ManyToOne</div><div class="line">private Student student;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>@ManyToOne 标识多对一的多这一端，同理@OneToMany、@OneToOne、@ManyToMany也是同字面上的意思<br>编写Student类（同时补全StudentRepository、StudentService、StudentServiceImpl类）<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@Entity</div><div class="line">public class Student &#123;</div><div class="line">	@Id</div><div class="line">	@GeneratedValue(generator = &quot;uuid2&quot;)</div><div class="line">    @GenericGenerator(name = &quot;uuid2&quot;, strategy = &quot;uuid2&quot;)</div><div class="line">	@Type(type=&quot;pg-uuid&quot;)</div><div class="line">	private UUID id;</div><div class="line">	@Column(length=64)</div><div class="line">	private String name;</div><div class="line">	@OneToMany</div><div class="line">	private List&lt;Book&gt; books;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>完成后，我们测试一下，修改HomeController<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@Controller</div><div class="line">@EnableAutoConfiguration</div><div class="line">public class HomeController &#123;</div><div class="line">	@Autowired</div><div class="line">	private BookService bookService;</div><div class="line">	</div><div class="line">	@Autowired</div><div class="line">	private StudentService studentService;</div><div class="line"></div><div class="line">	@RequestMapping(&quot;/&quot;)</div><div class="line">	String home() &#123;</div><div class="line">		try &#123;</div><div class="line">			Student student = new Student();</div><div class="line">			student.setName(&quot;小明&quot;);</div><div class="line">			studentService.saveStudent(student);</div><div class="line">			List&lt;Book&gt; books = new ArrayList&lt;Book&gt;();</div><div class="line">			</div><div class="line">			for (int i = 0; i &lt; 10; i++) &#123;</div><div class="line">				Book book = new Book();</div><div class="line">				book.setName(&quot;测试书&quot; + i);</div><div class="line">				book.setPublisher(&quot;测试出版社&quot; + i);</div><div class="line">				book.setPublisher_year(new SimpleDateFormat(&quot;yyyy-MM-dd&quot;).parse(&quot;2012-12-12&quot;));</div><div class="line">				book.setStudent(student);</div><div class="line">				bookService.saveBook(book);</div><div class="line">				books.add(book);</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">			student.setBooks(books);</div><div class="line">			studentService.saveStudent(student);</div><div class="line">		&#125; catch (ParseException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">			return &quot;redirect:error&quot;;</div><div class="line">		&#125;</div><div class="line">		return &quot;home&quot;;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>之后启动并访问首页<br><img src="/img/springboot/onetomany.png" alt="关系映射"><br>我们看到了由于有多映射端，生成了中间表，同时在one端生成了外键</p>
<p></p><h2 id="transaction">多数据源与事务</h2><p></p>
<blockquote>
<p>在这里，我们先假设两个数据源。一个是school，包括了Book和Student。一个是game，包括了Game</p>
</blockquote>
<p>首先我们注释掉原来spring:datasource的默认数据源，配置两个新的数据源<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">datasource:</div><div class="line">  school:</div><div class="line">    url: jdbc:postgresql://localhost:5432/school</div><div class="line">    username: dzf</div><div class="line">    password: 123456</div><div class="line">  game:</div><div class="line">    url: jdbc:postgresql://localhost:5432/game</div><div class="line">    username: dzf</div><div class="line">    password: 123456</div></pre></td></tr></table></figure></p>
<p>同时需要实例化两个数据源，新建DataConfiguration类<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@Configuration</div><div class="line">public class DataConfiguration &#123;</div><div class="line">	@Bean(name=&quot;schoolDataSource&quot;)  </div><div class="line">	@Primary</div><div class="line">    @ConfigurationProperties(prefix=&quot;datasource.school&quot;)</div><div class="line">    public DataSource primaryDataSource() &#123;  </div><div class="line">        return DataSourceBuilder.create().build();  </div><div class="line">    &#125;</div><div class="line">	</div><div class="line">	@Bean(name=&quot;gameDataSource&quot;)</div><div class="line">    @ConfigurationProperties(prefix=&quot;datasource.game&quot;)</div><div class="line">    public DataSource gameDataSource() &#123;  </div><div class="line">        return DataSourceBuilder.create().build();  </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来我们在domain和service中分别新建school与game包（同时补全Game、GameRepository、GameService、GameServiceImpl）</p>
<blockquote>
<p>配置GameConfig和SchoolConfig，以GameConfig为例<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@Configuration</div><div class="line">@EnableJpaRepositories(entityManagerFactoryRef = &quot;gameEntityManagerFactory&quot;, transactionManagerRef = &quot;gameTransactionManager&quot;)</div><div class="line">public class GameConfig &#123;</div><div class="line">	@Autowired</div><div class="line">	@Qualifier(&quot;gameDataSource&quot;)</div><div class="line">	private DataSource gameDataSource;</div><div class="line"></div><div class="line">	@Bean</div><div class="line">	PlatformTransactionManager gameTransactionManager() &#123;</div><div class="line">		return new JpaTransactionManager(gameEntityManagerFactory().getObject());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Bean</div><div class="line">	LocalContainerEntityManagerFactoryBean gameEntityManagerFactory() &#123;</div><div class="line"></div><div class="line">		HibernateJpaVendorAdapter vendorAdapter = new HibernateJpaVendorAdapter();</div><div class="line">		vendorAdapter.setGenerateDdl(true);</div><div class="line"></div><div class="line">		LocalContainerEntityManagerFactoryBean factoryBean = new LocalContainerEntityManagerFactoryBean();</div><div class="line"></div><div class="line">		factoryBean.setDataSource(gameDataSource);</div><div class="line">		factoryBean.setJpaVendorAdapter(vendorAdapter);</div><div class="line">		factoryBean.setPackagesToScan(&quot;org.dzf.domain.game&quot;);</div><div class="line"></div><div class="line">		return factoryBean;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>@EnableJpaRepositories 注解用于Repositorie的配置，事务由transactionManagerRef属性注入</p>
<blockquote>
<p>事务回滚，假设我们可以保存多个游戏，但是超过三个就认为是不正常的，不可以保存</p>
</blockquote>
<p>在GameService增加方法 <code>saveGameList(List&lt;Game&gt; games);</code><br>在GameServiceImpl实现这个方法<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@Service(value = &quot;gameService&quot;)</div><div class="line">public class GameServiceImpl implements GameService&#123;</div><div class="line">	@Resource(name = &quot;gameRepository&quot;)</div><div class="line">	private GameRepository GameRepository;</div><div class="line">	</div><div class="line">	@Transactional(transactionManager=&quot;gameTransactionManager&quot;,rollbackFor=RuntimeException.class)</div><div class="line">	public void saveGameList(List&lt;Game&gt; games) &#123;</div><div class="line">		int i = 0;</div><div class="line">		for (Game game : games) &#123;</div><div class="line">			GameRepository.save(game);</div><div class="line">			i++;</div><div class="line">		&#125;</div><div class="line">		if(i &gt; 3)</div><div class="line">			throw new RuntimeException(); </div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>@Transactional 注解声明了方法是被事务管理的，transactionManager需要注入对应的事务管理类，rollbackFor为回滚条件</p>
<p>好了，现在我们测试一下，修改HomeController<br><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">@RequestMapping(&quot;/&quot;)</div><div class="line">String home() &#123;</div><div class="line">	try &#123;</div><div class="line">		List&lt;Game&gt; games = new ArrayList&lt;Game&gt;();</div><div class="line">		for(int i =0;i&lt;3;i++)&#123;</div><div class="line">			Game game = new Game();</div><div class="line">			game.setName(&quot;游戏名&quot; + i);</div><div class="line">			games.add(game);</div><div class="line">		&#125;</div><div class="line">		gameService.saveGameList(games);</div><div class="line">		</div><div class="line">		games.removeAll(games);</div><div class="line">		for(int i =3;i&lt;13;i++)&#123;</div><div class="line">			Game game = new Game();</div><div class="line">			game.setName(&quot;游戏名&quot; + i);</div><div class="line">			games.add(game);</div><div class="line">		&#125;</div><div class="line">		gameService.saveGameList(games);</div><div class="line">	&#125; catch (Exception e) &#123;</div><div class="line">		e.printStackTrace();</div><div class="line">		return &quot;redirect:error&quot;;</div><div class="line">	&#125;</div><div class="line">	return &quot;home&quot;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>启动后访问主页，发现主页跳转到出错页，同时game表有插入三行数据<br><img src="/img/springboot/transaction.png" alt="事务"></p>
<blockquote>
<p>好了，到目前为止已经能通过spring boot完成多数工作了，web.xml的配置也可以通过@WebServlet、@WebFilter、@WebListener 配置完成。多数情况下，已经可以通过注解脱离xml的配置了</p>
</blockquote>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/springboot/" rel="tag">#springboot</a>
          
            <a href="/tags/jpa/" rel="tag">#jpa</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/05/03/ssm/" rel="next">搭建一个spring、springMVC、mybatis工程</a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

 </div>

        

        
          <div class="comments" id="comments">
            
              <div class="ds-thread" data-thread-key="2016/06/12/springboot/"
                   data-title="使用springboot+jpa快速搭建无xml配置web应用" data-url="http://yoursite.com/2016/06/12/springboot/">
              </div>
            
          </div>
        
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/img/avatar.jpg" alt="沙沙声" itemprop="image"/>
          <p class="site-author-name" itemprop="name">沙沙声</p>
        </div>
        <p class="site-description motion-element" itemprop="description">dengzhengfeng1991@126.com</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">5</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">4</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">9</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#context"><span class="nav-number">1.</span> <span class="nav-text">准备环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gradle"><span class="nav-number">2.</span> <span class="nav-text">初始化项目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ide"><span class="nav-number">3.</span> <span class="nav-text">导入IDE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dependency"><span class="nav-number">4.</span> <span class="nav-text">配置依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hello"><span class="nav-number">5.</span> <span class="nav-text">Hello World！</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#config"><span class="nav-number">6.</span> <span class="nav-text">配置文件与资源文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#jpa"><span class="nav-number">7.</span> <span class="nav-text">使用jpa完成数据持久化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mapping"><span class="nav-number">8.</span> <span class="nav-text">关系映射</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#transaction"><span class="nav-number">9.</span> <span class="nav-text">多数据源与事务</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; &nbsp;  2015 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="icon-next-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">沙沙声</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"rustle"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     

    
  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.1" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 0.4 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    var $tocContent = $('.post-toc-content');
    if (isDesktop() && CONFIG.sidebar === 'post') {
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
        displaySidebar();
      }
    }
  });
</script>



  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  

  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
